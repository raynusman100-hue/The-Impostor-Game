import { LinearGradient } from 'expo-linear-gradient';
import { useTheme } from '../utils/ThemeContext';
import Button from '../components/Button';
import KodakButton from '../components/KodakButton';
import { playHaptic } from '../utils/haptics';
import { database } from '../utils/firebase';
import { ref, onValue, off, remove, get } from 'firebase/database';
import { CustomAvatar } from '../utils/AvatarGenerator';
import { CustomBuiltAvatar } from '../components/CustomAvatarBuilder';

import ChatSystem from '../components/ChatSystem';
import VoiceControl from '../components/VoiceControl';
import { useVoiceChat } from '../utils/VoiceChatContext';
import { useVoiceParticipantsTracker } from '../utils/VoiceParticipantsTracker';

// Film perforation component for Kodak aesthetic (same as SetupScreen)
const FilmPerforations = ({ side, theme }) => {
    const perforationColor = theme.colors.primary + '40';

    return (
        <View style={[filmPerforationStyles.perforationStrip, side === 'left' ? filmPerforationStyles.leftStrip : filmPerforationStyles.rightStrip]}>
            {[...Array(12)].map((_, i) => (
                <View key={i} style={[filmPerforationStyles.perforation, { backgroundColor: perforationColor }]} />
            ))}
        </View>
    );
};

const filmPerforationStyles = StyleSheet.create({
    perforationStrip: {
        position: 'absolute',
        top: 0,
        bottom: 0,
        width: 18,
        justifyContent: 'space-evenly',
        alignItems: 'center',
        paddingVertical: 40,
        zIndex: 1,
    },
    leftStrip: { left: 2 },
    rightStrip: { right: 2 },
    perforation: {
        width: 10,
        height: 14,
        borderRadius: 2,
        borderWidth: 1,
        borderColor: 'rgba(255, 184, 0, 0.3)',
    },
});

export default function WifiLobbyScreen({ route, navigation }) {
    const { theme } = useTheme();
    const styles = getStyles(theme);
    const { roomCode, playerId, playerName, stampedAppId } = route.params; // <--- RECEIVED STAMPED ID

    console.log(`ðŸŽ® WIFI LOBBY: Player ${playerId} (${playerName}) joined room ${roomCode}`);

    const [players, setPlayers] = useState([]);
    const [roomStatus, setRoomStatus] = useState('lobby');

    // Host Data
    const [hostName, setHostName] = useState('Waiting...');
    const [hostAvatar, setHostAvatar] = useState(1);
    const [hostAvatarConfig, setHostAvatarConfig] = useState(null);

    const [activeTab, setActiveTab] = useState('lobby'); // 'lobby' | 'chat' | 'voice'
    const [unreadMessages, setUnreadMessages] = useState(0);

    // Voice Chat Integration
    const { isJoined, joinChannel, leaveChannel } = useVoiceChat();
    const [voiceParticipants, setVoiceParticipants] = useState([]);

    // Track voice participants in Firebase
    useVoiceParticipantsTracker(
        roomCode,
        playerId,
        { name: playerName, avatarId: 1, customAvatarConfig: null }, // Player data for non-host
        isJoined,
        setVoiceParticipants
    );
    // Auto-join REMOVED - User must join manually via Voice tab

    // Disable Android back button
    useEffect(() => {
        const backHandler = BackHandler.addEventListener('hardwareBackPress', () => {
            Alert.alert(
                'Leave Room?',
                'Are you sure you want to leave the room?',
                [
                    { text: 'Stay', style: 'cancel' },
                    {
                        text: 'Leave',
                        style: 'destructive',
                        onPress: () => {
                            if (roomCode && playerId) {
                                const playerRef = ref(database, `rooms/${roomCode}/players/${playerId}`);
                                remove(playerRef).catch(err => console.error("Error removing player:", err));
                            }
                            navigation.navigate('Home');
                        }
                    }
                ]
            );
            return true; // Prevent default back behavior
        });

        return () => backHandler.remove();
    }, [roomCode, playerId, navigation]);

    // Enhanced unread message handler
    const handleUnreadChange = useCallback((count) => {
        // Only show unread count when chat is not active
        if (activeTab !== 'chat') {
            setUnreadMessages(count);
        } else {
            setUnreadMessages(0);
        }
    }, [activeTab]);

    // Reset unread messages when switching to chat tab
    useEffect(() => {
        if (activeTab === 'chat') {
            setUnreadMessages(0);
        }
    }, [activeTab]);
    const pulseAnim = React.useRef(new Animated.Value(1)).current;

    useEffect(() => {
        Animated.loop(
            Animated.sequence([
                Animated.timing(pulseAnim, { toValue: 1.05, duration: 1000, useNativeDriver: true }),
                Animated.timing(pulseAnim, { toValue: 1, duration: 1000, useNativeDriver: true }),
            ])
        ).start();

        let hasNavigated = false;

        const navigateToGame = (status) => {
            if (hasNavigated) return;
            hasNavigated = true;

            console.log(`ðŸŽ¯ LOBBY: Navigating to ${status} for player ${playerId}`);

            if (status === 'voting') {
                navigation.replace('WifiVoting', { roomCode, userId: playerId });
            } else if (status === 'game' || status === 'roles' || status === 'reveal') {
                navigation.replace('RoleReveal', {
                    mode: 'wifi',
                    roomCode: roomCode,
                    playerId: playerId,
                });
            }
        };

        const roomRef = ref(database, `rooms/${roomCode}`);
        const playersRef = ref(database, `rooms/${roomCode}/players`);

        // Listener for Room Status & Host Info
        const roomUnsubscribe = onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                console.log(`ðŸŽ¯ LOBBY: [${playerId}] Room status = ${data.status}`);
                setRoomStatus(data.status);
                setHostName(data.host || 'Unknown Host');
                setHostAvatar(data.hostAvatar || 1);
                setHostAvatarConfig(data.hostAvatarConfig || null);

                if (!hasNavigated && (data.status === 'voting' || data.status === 'game' || data.status === 'roles' || data.status === 'reveal')) {
                    navigateToGame(data.status);
                }
            } else {
                // Room deleted - but wait a moment to confirm it's really gone
                // (prevents false positives during play again transitions)
                setTimeout(async () => {
                    if (hasNavigated) return;

                    // Double-check the room is really gone
                    const recheck = await get(roomRef);
                    if (!recheck.exists() && !hasNavigated) {
                        hasNavigated = true;
                        Alert.alert('Room Closed', 'The host has ended the game.');
                        navigation.navigate('Home');
                    }
                }, 500);
            }
        });

        // Listener for Players - with immediate state update
        const playersUnsubscribe = onValue(playersRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // Filter out any null/undefined entries and create fresh array
                const playerList = Object.entries(data)
                    .filter(([id, info]) => info && info.name) // Only include valid players
                    .map(([id, info]) => ({
                        id,
                        ...info
                    }));
                // Replace entire state with new array
                setPlayers(playerList);
            } else {
                setPlayers([]);
            }
        });

        // BACKUP: Periodic check every 2 seconds in case listener misses update
        const checkInterval = setInterval(async () => {
            if (hasNavigated) {
                clearInterval(checkInterval);
                return;
            }

            try {
                const snapshot = await get(roomRef);
                const data = snapshot.val();

                if (data && !hasNavigated) {
                    const status = data.status;
                    if (status === 'voting' || status === 'game' || status === 'roles' || status === 'reveal') {
                        console.log(`ðŸŽ¯ LOBBY: [PERIODIC CHECK] Status is ${status} - navigating!`);
                        clearInterval(checkInterval);
                        navigateToGame(status);
                    }
                }
            } catch (err) {
                console.error("ðŸš¨ LOBBY: Periodic check error:", err);
            }
        }, 2000);

        return () => {
            off(roomRef);
            off(playersRef);
            clearInterval(checkInterval);
        };
    }, [roomCode, playerId, navigation]);

    return (
        <LinearGradient
            colors={theme.colors.backgroundGradient || [theme.colors.background, theme.colors.background, theme.colors.background]}
            style={styles.container}
        >
            {/* Film perforations - side strips */}
            <FilmPerforations side="left" theme={theme} />
            <FilmPerforations side="right" theme={theme} />

            {/* Floating Voice Control - Always visible when joined */}
            {isJoined && <VoiceControl />}

            {/* Kodak Film Header */}
            <View style={styles.filmHeader}>
                <View style={styles.filmStrip}>
                    {[...Array(16)].map((_, i) => (
                        <View key={i} style={styles.filmHole} />
                    ))}
                </View>
            </View>

            <View style={styles.header}>
                <Text style={styles.roomLabel}>WAITING IN ROOM</Text>
                <Animated.Text style={[styles.roomCode, { transform: [{ scale: pulseAnim }] }]}>
                    {roomCode}
                </Animated.Text>
            </View>


            {/* Tabs: Lobby | Chat | Voice - Matching Host UI */}
            <View style={styles.tabContainer}>
                <TouchableOpacity
                    style={[styles.tab, activeTab === 'lobby' && styles.activeTab]}
                    onPress={() => {
                        playHaptic('light');
                        setActiveTab('lobby');
                    }}
                >
                    <Text style={[styles.tabText, activeTab === 'lobby' && styles.activeTabText]}>LOBBY</Text>
                </TouchableOpacity>
                <TouchableOpacity
                    style={[styles.tab, activeTab === 'chat' && styles.activeTab]}
                    onPress={() => {
                        playHaptic('light');
                        setActiveTab('chat');
                        setUnreadMessages(0);
                    }}
                >
                    <View style={styles.tabContent}>
                        <Text style={[styles.tabText, activeTab === 'chat' && styles.activeTabText]}>CHAT</Text>
                        {unreadMessages > 0 && activeTab !== 'chat' && (
                            <View style={styles.notificationDot} />
                        )}
                    </View>
                </TouchableOpacity>
                <TouchableOpacity
                    style={[styles.tab, activeTab === 'voice' && styles.activeTab]}
                    onPress={() => {
                        playHaptic('light');
                        setActiveTab('voice');
                    }}
                >
                    <Text style={[styles.tabText, activeTab === 'voice' && styles.activeTabText]}>VOICE</Text>
                </TouchableOpacity>
            </View>

            <View style={styles.content}>
                {activeTab === 'chat' ? (
                    <ChatSystem
                        roomCode={roomCode}
                        playerId={playerId}
                        playerName={playerName}
                        onUnreadChange={handleUnreadChange}
                    />
                ) : activeTab === 'voice' ? (
                    <View style={styles.voiceContainer}>
                        {!isJoined ? (
                            <>
                                <Text style={styles.voiceInstructions}>
                                    VOICE CHAT
                                </Text>
                                {voiceParticipants.length > 0 ? (
                                    <Text style={styles.voiceSubInstructions}>
                                        {voiceParticipants.length} {voiceParticipants.length === 1 ? 'MEMBER' : 'MEMBERS'} IN CALL
                                    </Text>
                                ) : (
                                    <Text style={styles.voiceSubInstructions}>
                                        No one in voice chat yet
                                    </Text>
                                )}
                                <TouchableOpacity
                                    style={styles.joinVoiceBtn}
                                    onPress={() => {
                                        playHaptic('heavy');
                                        console.log('ðŸŽ¤ WifiLobby: Joining with stamped App ID:', stampedAppId);
                                        joinChannel(roomCode, 0, stampedAppId);
                                    }}
                                >
                                    <View style={styles.joinVoiceInner}>
                                        <Text
                                            style={styles.joinVoiceText}
                                            numberOfLines={1}
                                            adjustsFontSizeToFit
                                        >
                                            JOIN CALL
                                        </Text>
                                    </View>
                                </TouchableOpacity>
                            </>
                        ) : (
                            <>
                                <Text style={styles.voiceInstructions}>
                                    IN VOICE CHAT
                                </Text>

                                {/* Participants List */}
                                <View style={styles.voiceParticipantsList}>
                                    {voiceParticipants.map((participant) => (
                                        <View key={participant.id} style={styles.voiceParticipantRow}>
                                            {participant.customAvatarConfig ? (
                                                <CustomBuiltAvatar config={participant.customAvatarConfig} size={32} />
                                            ) : (
                                                <CustomAvatar id={participant.avatarId || 1} size={32} />
                                            )}
                                            <Text style={styles.voiceParticipantName} numberOfLines={1}>
                                                {participant.id === playerId ? 'You' : participant.name}
                                            </Text>
                                        </View>
                                    ))}
                                </View>

                                <Text style={[styles.voiceSubInstructions, { marginTop: 20, color: theme.colors.tertiary }]}>
                                    Use the floating mic button to mute/unmute
                                </Text>

                                <TouchableOpacity
                                    style={styles.leaveVoiceBtn}
                                    onPress={() => {
                                        playHaptic('medium');
                                        leaveChannel();
                                    }}
                                >
                                    <Text
                                        style={styles.leaveVoiceText}
                                        numberOfLines={1}
                                        adjustsFontSizeToFit
                                    >
                                        LEAVE CALL
                                    </Text>
                                </TouchableOpacity>
                            </>
                        )}
                    </View>
                ) : (
                    <>
                        <View style={styles.loaderContainer}>
                            <ActivityIndicator size="large" color={theme.colors.tertiary} style={styles.loader} />
                            <Text style={styles.statusText}>WAITING FOR HOST TO START...</Text>
                        </View>


                        <View style={styles.playerBox}>
                            <Text
                                style={styles.playerCount}
                                numberOfLines={1}
                                adjustsFontSizeToFit
                                minimumFontScale={0.8}
                            >
                                PLAYERS JOINED: {players.length + 1}
                            </Text>

                            {/* Host Row */}
                            <View style={styles.playerRow}>
                                {hostAvatarConfig ? (
                                    <CustomBuiltAvatar config={hostAvatarConfig} size={32} />
                                ) : (
                                    <CustomAvatar id={hostAvatar} size={32} />
                                )}
                                <Text style={styles.playerName} numberOfLines={1} ellipsizeMode="tail">
                                    {hostName.toUpperCase()} (HOST)
                                </Text>
                            </View>

                            {/* Players Rows */}
                            {players.map(p => (
                                <View key={p.id} style={styles.playerRow}>
                                    {p.customAvatarConfig ? (
                                        <CustomBuiltAvatar config={p.customAvatarConfig} size={32} />
                                    ) : (
                                        <CustomAvatar id={p.avatarId || 1} size={32} />
                                    )}
                                    <Text style={styles.playerName} numberOfLines={1} ellipsizeMode="tail">
                                        {p.name}
                                    </Text>
                                </View>
                            ))}
                        </View>
                    </>
                )}
            </View>

            {activeTab === 'lobby' && (
                <KodakButton
                    title="LEAVE ROOM"
                    onPress={async () => {
                        playHaptic('medium');
                        if (roomCode && playerId) {
                            const playerRef = ref(database, `rooms/${roomCode}/players/${playerId}`);
                            await remove(playerRef);
                        }
                        navigation.navigate('Home');
                    }}
                    variant="secondary"
                    style={styles.leaveBtn}
                />
            )}

            {/* Kodak Film Footer */}
            <View style={styles.filmFooter}>
                <View style={styles.filmStrip}>
                    {[...Array(16)].map((_, i) => (
                        <View key={i} style={styles.filmHole} />
                    ))}
                </View>
            </View>


        </LinearGradient>
    );
}

function getStyles(theme) {
    return StyleSheet.create({
        container: {
            flex: 1,
            padding: theme.spacing.xl,
            alignItems: 'center',
        },

        // Kodak Film Strip Decorations
        filmHeader: {
            width: '100%',
            position: 'absolute',
            top: 40,
            left: 0,
            right: 0,
        },
        filmFooter: {
            width: '100%',
            position: 'absolute',
            bottom: 15,
            left: 0,
            right: 0,
        },
        filmStrip: {
            flexDirection: 'row',
            justifyContent: 'space-evenly',
            paddingHorizontal: 5,
        },
        filmHole: {
            width: 12,
            height: 8,
            backgroundColor: theme.colors.primary,
            borderRadius: 2,
            opacity: 0.8,
        },

        header: {
            marginTop: 60,
            alignItems: 'center',
            marginBottom: 20,
            position: 'relative',
            width: '100%',
        },
        roomLabel: {
            fontSize: 14,
            color: theme.colors.tertiary,
            fontFamily: theme.fonts.bold,
            letterSpacing: 6,
        },
        roomCode: {
            fontSize: 52,
            color: theme.colors.text,
            fontFamily: theme.fonts.header,
            letterSpacing: 10,
            ...theme.textShadows.depth,
        },

        tabContainer: {
            flexDirection: 'row',
            marginBottom: 12,
            backgroundColor: theme.colors.surface,
            borderRadius: 25,
            padding: 4,
            borderWidth: 2,
            borderColor: theme.colors.primary,
            alignSelf: 'center',
        },
        tab: {
            paddingVertical: 8,
            paddingHorizontal: 30,
            borderRadius: 20,
        },
        activeTab: {
            backgroundColor: theme.colors.primary,
        },
        tabText: {
            color: theme.colors.textMuted,
            fontFamily: theme.fonts.bold,
            fontSize: 13,
            letterSpacing: 2,
        },
        activeTabText: {
            color: theme.colors.secondary,
        },
        tabContent: {
            flexDirection: 'row',
            alignItems: 'center',
        },
        notificationDot: {
            position: 'absolute',
            top: -6,
            right: -8,
            backgroundColor: theme.colors.error,
            borderRadius: 6,
            width: 12,
            height: 12,
            borderWidth: 2,
            borderColor: theme.colors.background,
        },

        // Version 2: Horizontal Tabs + Premium Voice
        topTabs: {
            flexDirection: 'row',
            gap: 12,
            marginBottom: 16,
            paddingHorizontal: 20,
        },
        topTab: {
            flex: 1,
            paddingVertical: 14,
            paddingHorizontal: 20,
            borderRadius: 16,
            alignItems: 'center',
            backgroundColor: theme.colors.surface,
            borderWidth: 2,
            borderColor: theme.colors.primary + '30',
        },
        topTabActive: {
            backgroundColor: theme.colors.primary + '15',
            borderColor: theme.colors.primary,
            shadowColor: theme.colors.primary,
            shadowOffset: { width: 0, height: 2 },
            shadowOpacity: 0.3,
            shadowRadius: 4,
            elevation: 4,
        },
        topTabText: {
            fontSize: 14,
            fontFamily: theme.fonts.bold,
            color: theme.colors.textMuted,
            letterSpacing: 2.5,
        },
        topTabTextActive: {
            color: theme.colors.primary,
        },
        topTabCount: {
            fontSize: 20,
            fontFamily: theme.fonts.header,
            color: theme.colors.textMuted,
            marginTop: 4,
        },
        chatBadge: {
            position: 'absolute',
            top: -8,
            right: -8,
            backgroundColor: theme.colors.error,
            borderRadius: 10,
            minWidth: 20,
            height: 20,
            paddingHorizontal: 6,
            alignItems: 'center',
            justifyContent: 'center',
            borderWidth: 2,
            borderColor: theme.colors.background,
        },
        chatBadgeText: {
            fontSize: 11,
            fontFamily: theme.fonts.bold,
            color: '#fff',
        },

        // Premium Voice Section
        voiceSection: {
            marginHorizontal: 20,
            marginBottom: 20,
            borderRadius: 20,
            overflow: 'hidden',
            borderWidth: 2,
            borderColor: theme.colors.primary + '40',
        },
        voiceSectionActive: {
            borderWidth: 3,
            borderColor: theme.colors.primary,
            shadowColor: theme.colors.primary,
            shadowOffset: { width: 0, height: 6 },
            shadowOpacity: 0.4,
            shadowRadius: 12,
            elevation: 10,
        },
        voiceSectionGradient: {
            backgroundColor: theme.colors.surface,
        },
        voiceSectionContent: {
            flexDirection: 'row',
            alignItems: 'center',
            padding: 20,
            gap: 16,
        },
        voiceIconWrapper: {
            position: 'relative',
        },
        voiceIcon: {
            fontSize: 36,
        },
        voiceLiveDot: {
            position: 'absolute',
            top: 0,
            right: -2,
            width: 10,
            height: 10,
            borderRadius: 5,
            borderWidth: 2,
            borderColor: theme.colors.background,
        },
        voiceTextWrapper: {
            flex: 1,
        },
        voiceTitle: {
            fontSize: 16,
            fontFamily: theme.fonts.bold,
            color: theme.colors.text,
            letterSpacing: 3,
            marginBottom: 4,
        },
        voiceStatus: {
            fontSize: 12,
            fontFamily: theme.fonts.medium,
            color: theme.colors.textMuted,
            letterSpacing: 0.5,
        },
        voiceArrow: {
            fontSize: 32,
            color: theme.colors.primary,
            fontWeight: '300',
        },

        content: {
            flex: 1,
            width: '100%',
            justifyContent: 'center',
            alignItems: 'center',
        },
        loaderContainer: {
            alignItems: 'center',
            marginBottom: 30,
        },
        loader: {
            marginBottom: 20,
        },
        statusText: {
            fontSize: 18,
            color: theme.colors.text,
            fontFamily: theme.fonts.bold,
            textAlign: 'center',
            letterSpacing: 3,
            ...theme.textShadows.softDepth,
        },

        playerBox: {
            width: '100%',
            padding: 20,
            borderRadius: 16,
            borderWidth: 2,
            borderColor: theme.colors.primary,
            backgroundColor: theme.colors.surface,
        },
        playerCount: {
            fontSize: 14,
            color: theme.colors.tertiary,
            fontFamily: theme.fonts.bold,
            marginBottom: 15,
            letterSpacing: 3,
        },
        playerName: {
            fontSize: 18,
            color: theme.colors.text,
            fontFamily: theme.fonts.medium,
            marginBottom: 4,
            flex: 1,
            letterSpacing: 1,
        },
        playerRow: {
            flexDirection: 'row',
            alignItems: 'center',
            gap: 12,
            marginBottom: 8
        },

        leaveBtn: {
            width: '100%',
            marginBottom: 50,
        },

        // Voice Tab Styles
        voiceContainer: {
            flex: 1,
            justifyContent: 'center',
            alignItems: 'center',
            width: '100%',
        },
        voiceInstructions: {
            fontSize: 24,
            fontFamily: theme.fonts.header,
            color: theme.colors.primary,
            letterSpacing: 2,
            marginBottom: 10,
            textAlign: 'center',
            ...theme.textShadows.glow,
        },
        voiceSubInstructions: {
            fontSize: 14,
            fontFamily: theme.fonts.medium,
            color: theme.colors.tertiary,
            letterSpacing: 1,
            textAlign: 'center',
            opacity: 0.8,
            marginBottom: 30,
        },
        voiceParticipantsList: {
            width: '100%',
            maxWidth: 300,
            marginVertical: 20,
            gap: 12,
        },
        voiceParticipantRow: {
            flexDirection: 'row',
            alignItems: 'center',
            gap: 12,
            paddingVertical: 8,
            paddingHorizontal: 16,
            borderRadius: 12,
            backgroundColor: theme.colors.surface,
            borderWidth: 1,
            borderColor: theme.colors.primary + '30',
        },
        voiceParticipantName: {
            fontSize: 16,
            fontFamily: theme.fonts.medium,
            color: theme.colors.text,
            letterSpacing: 1,
            flex: 1,
        },
        joinVoiceBtn: {
            width: 120,
            height: 120,
            borderRadius: 60,
            backgroundColor: theme.colors.primary,
            justifyContent: 'center',
            alignItems: 'center',
            elevation: 10,
            shadowColor: theme.colors.primary,
            shadowOffset: { width: 0, height: 4 },
            shadowOpacity: 0.5,
            shadowRadius: 10,
            marginTop: 20,
        },
        joinVoiceInner: {
            width: 110,
            height: 110,
            borderRadius: 55,
            borderWidth: 2,
            borderColor: theme.colors.secondary,
            justifyContent: 'center',
            alignItems: 'center',
            backgroundColor: theme.colors.primary,
        },
        joinVoiceText: {
            fontFamily: theme.fonts.bold,
            color: theme.colors.secondary,
            fontSize: 18,
            textAlign: 'center',
        },
        leaveVoiceBtn: {
            marginTop: 40,
            paddingVertical: 10,
            paddingHorizontal: 20,
            borderRadius: 8,
            borderWidth: 1,
            borderColor: theme.colors.error,
        },
        leaveVoiceText: {
            color: theme.colors.error,
            fontFamily: theme.fonts.bold,
            fontSize: 12,
            letterSpacing: 2,
        },
    });
}
